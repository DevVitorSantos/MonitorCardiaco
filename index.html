<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Press√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #5a6c7d;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 25px;
            color: #4a5568;
            text-align: center;
            font-weight: 300;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 50px;
        }

        .upload-form {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px dashed #e2e8f0;
            transition: all 0.3s ease;
        }

        .upload-form:hover {
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            margin-top: 15px;
            font-style: italic;
            color: #718096;
        }

        .upload-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
            opacity: 0.7;
            pointer-events: none;
        }

        .upload-button.active {
            opacity: 1;
            pointer-events: auto;
        }

        .upload-button.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        /* Status Messages */
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-success {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            border: 1px solid #68d391;
        }

        .status-error {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status-loading {
            background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);
            color: #2a4365;
            border: 1px solid #63b3ed;
        }

        /* Chart Section */
        .chart-section {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        /* Loading Spinner */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1em;
            font-weight: 500;
        }

        /* Data Source Indicator */
        .data-source-indicator {
            text-align: center;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: none;
        }

        .data-source-dummy {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #8b5a00;
            border: 2px solid #e17055;
        }

        .data-source-api {
            background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
            color: #22543d;
            border: 2px solid #68d391;
        }

        .data-source-error {
            background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        /* Chart Info */
        .chart-info {
            margin-top: 20px;
            text-align: center;
            color: #718096;
            font-size: 0.9em;
            display: none;
        }

        .chart-info.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .content {
                padding: 20px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .upload-form {
                padding: 20px;
            }

            .chart-container, .loading-container {
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            .file-input-button, .upload-button {
                padding: 12px 25px;
                font-size: 1em;
            }

            .section-title {
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Monitor de Press√£o</h1>
            <p>Upload de imagem e visualiza√ß√£o de dados de press√£o</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2 class="section-title">Envio de Imagem</h2>
                <div class="upload-form">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFile" class="file-input" accept="image/*">
                        <button class="file-input-button">
                            üì∏ Selecionar Imagem
                        </button>
                    </div>
                    <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
                    <button id="uploadButton" class="upload-button">
                        üöÄ Enviar Imagem
                    </button>
                    <div id="statusMessage" class="status-message"></div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="chart-section">
                <h2 class="section-title">Monitoramento Di√°rio da Press√£o</h2>
                
                <!-- Loading Container -->
                <div id="loadingContainer" class="loading-container">
                    <div class="spinner"></div>
                    <div class="loading-text">Carregando dados...</div>
                </div>
                
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="pressureChart"></canvas>
                </div>
                
                <!-- Data Source Indicator -->
                <div id="dataSourceIndicator" class="data-source-indicator"></div>
                
                <!-- Chart Info -->
                <div id="chartInfo" class="chart-info">
                    <p>üìà <strong>Linhas pontilhadas</strong> mostram a tend√™ncia ao longo do tempo</p>
                    <p style="margin-top: 5px;">üí° Valores de press√£o em formato decimal (ex: 12,5 / 8,0)</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedFile = null;
        let pressureChart = null;
        let isLoadingData = false;
        let currentDataSource = 'dummy'; // 'dummy' or 'api'

        // DOM elements
        const fileInput = document.getElementById('imageFile');
        const fileName = document.getElementById('fileName');
        const uploadButton = document.getElementById('uploadButton');
        const statusMessage = document.getElementById('statusMessage');
        const loadingContainer = document.getElementById('loadingContainer');
        const dataSourceIndicator = document.getElementById('dataSourceIndicator');
        const chartInfo = document.getElementById('chartInfo');
        const chartCanvas = document.getElementById('pressureChart');

        // Dummy data for initial display
        const dummyData = {
            dates: ['01/06', '02/06', '03/06', '04/06', '05/06', '06/06', '07/06'],
            systolic: [12.0, 11.5, 13.2, 12.8, 11.9, 12.5, 13.1],
            diastolic: [8.0, 7.8, 8.5, 8.2, 7.9, 8.1, 8.4]
        };

        // Calculate linear regression for trend line
        function calculateTrendLine(data) {
            const n = data.length;
            if (n === 0) return [];
            
            const sumX = data.reduce((sum, _, i) => sum + i, 0);
            const sumY = data.reduce((sum, val) => sum + val, 0);
            const sumXY = data.reduce((sum, val, i) => sum + (i * val), 0);
            const sumXX = data.reduce((sum, _, i) => sum + (i * i), 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            return data.map((_, i) => slope * i + intercept);
        }

        // Function to safely destroy existing chart
        function destroyChart() {
            if (pressureChart) {
                try {
                    pressureChart.destroy();
                    console.log('Gr√°fico anterior destru√≠do com sucesso');
                } catch (error) {
                    console.warn('Erro ao destruir gr√°fico anterior:', error);
                } finally {
                    pressureChart = null;
                }
            }
        }

        // Function to create chart
        function createChart(processedData) {
            console.log('Criando gr√°fico com dados:', processedData);
            
            // Always destroy existing chart first
            destroyChart();
            
            const ctx = chartCanvas.getContext('2d');
            
            const systolicTrend = calculateTrendLine(processedData.systolic);
            const diastolicTrend = calculateTrendLine(processedData.diastolic);

            const chartData = {
                labels: processedData.dates,
                datasets: [
                    {
                        label: 'Press√£o M√°xima (Sist√≥lica)',
                        data: processedData.systolic,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        fill: false
                    },
                    {
                        label: 'Press√£o M√≠nima (Diast√≥lica)',
                        data: processedData.diastolic,
                        borderColor: 'rgba(72, 187, 120, 1)',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(72, 187, 120, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        fill: false
                    },
                    {
                        label: 'Tend√™ncia Sist√≥lica',
                        data: systolicTrend,
                        borderColor: 'rgba(102, 126, 234, 0.6)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    },
                    {
                        label: 'Tend√™ncia Diast√≥lica',
                        data: diastolicTrend,
                        borderColor: 'rgba(72, 187, 120, 0.6)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        fill: false,
                        tension: 0
                    }
                ]
            };

            try {
                pressureChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monitoramento Di√°rio da Press√£o Arterial',
                                font: {
                                    size: 16,
                                    weight: 'normal'
                                },
                                color: '#4a5568',
                                padding: 20
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    color: '#4a5568',
                                    filter: function(legendItem, chartData) {
                                        if (legendItem.text.includes('Tend√™ncia')) {
                                            legendItem.fillStyle = 'transparent';
                                            legendItem.strokeStyle = legendItem.borderColor;
                                            legendItem.lineDash = [10, 5];
                                        }
                                        return true;
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#4a5568',
                                bodyColor: '#4a5568',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                cornerRadius: 8,
                                displayColors: true,
                                filter: function(tooltipItem) {
                                    return !tooltipItem.dataset.label.includes('Tend√™ncia');
                                },
                                callbacks: {
                                    title: function(context) {
                                        return 'Data: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(1);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Dias (Junho/2025)',
                                    color: '#718096',
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#718096'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Press√£o',
                                    color: '#718096',
                                    font: {
                                        size: 12
                                    }
                                },
                                beginAtZero: false,
                                min: 5,
                                max: 20,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#718096',
                                    stepSize: 1
                                }
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.4
                            },
                            point: {
                                hoverBorderWidth: 3
                            }
                        }
                    }
                });
                
                console.log('Novo gr√°fico criado com sucesso');
                return true;
            } catch (error) {
                console.error('Erro ao criar gr√°fico:', error);
                return false;
            }
        }

        // Function to load data from API
        async function loadPressureData() {
            try {
                console.log('Tentando carregar dados da API...');
                
                const response = await fetch('https://n8n-n8n-start.inrkp8.easypanel.host/webhook/get-data', {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Dados carregados da API:', data);
                return { success: true, data };
                
            } catch (error) {
                console.error('Erro ao carregar dados da API:', error);
                return { success: false, error: error.message };
            }
        }

        // Function to process API data
        function processApiData(apiData) {
            const processedData = {
                systolic: [],
                diastolic: [],
                dates: []
            };

            if (Array.isArray(apiData)) {
                apiData.forEach(item => {
                    try {
                        // Convert date format from DD/MM/YYYY to DD/MM
                        const dateStr = item.Data;
                        const dateParts = dateStr.split('/');
                        const formattedDate = `${dateParts[0]}/${dateParts[1]}`;
                        
                        processedData.dates.push(formattedDate);
                        processedData.systolic.push(parseFloat(item.Pressao_Maxima));
                        processedData.diastolic.push(parseFloat(item.Pressao_Minima));
                    } catch (error) {
                        console.warn('Erro ao processar item:', item, error);
                    }
                });
            }

            console.log('Dados processados da API:', processedData);
            return processedData;
        }

        // Function to show chart with appropriate data source indicator
        function showChart(data, source) {
            // Hide loading
            loadingContainer.style.display = 'none';
            
            // Create and show chart
            const chartCreated = createChart(data);
            
            if (chartCreated) {
                currentDataSource = source;
                
                // Show appropriate data source indicator
                if (source === 'api') {
                    dataSourceIndicator.className = 'data-source-indicator data-source-api';
                    dataSourceIndicator.textContent = '‚úÖ Dados reais carregados da API';
                } else {
                    dataSourceIndicator.className = 'data-source-indicator data-source-dummy';
                    dataSourceIndicator.textContent = 'üìä Exibindo dados de demonstra√ß√£o';
                }
                
                dataSourceIndicator.style.display = 'block';
                
                // Show chart info
                chartInfo.classList.add('show');
                
                console.log(`Interface atualizada com dados ${source}`);
            }
        }

        // Function to show error state
        function showError(errorMessage) {
            console.error('Mostrando erro:', errorMessage);
            
            // Hide loading
            loadingContainer.style.display = 'none';
            
            // Show error indicator
            dataSourceIndicator.className = 'data-source-indicator data-source-error';
            dataSourceIndicator.textContent = `‚ùå Erro: ${errorMessage}`;
            dataSourceIndicator.style.display = 'block';
            
            // Hide chart info
            chartInfo.classList.remove('show');
        }

        // Main function to load and display data
        async function loadAndShowData() {
            if (isLoadingData) {
                console.log('Carregamento j√° em andamento, pulando...');
                return;
            }
            
            isLoadingData = true;
            console.log('Iniciando carregamento de dados...');
            
            try {
                // Show loading state
                loadingContainer.style.display = 'flex';
                dataSourceIndicator.style.display = 'none';
                chartInfo.classList.remove('show');
                
                // Destroy any existing chart
                destroyChart();
                
                // Try to load from API first
                const result = await loadPressureData();
                
                if (result.success && result.data && result.data.length > 0) {
                    const processedData = processApiData(result.data);
                    
                    if (processedData.dates.length > 0) {
                        showChart(processedData, 'api');
                        console.log('Usando dados da API');
                    } else {
                        console.log('Dados da API inv√°lidos, usando dados dummy');
                        showChart(dummyData, 'dummy');
                    }
                } else {
                    console.log('API n√£o dispon√≠vel, usando dados dummy');
                    showChart(dummyData, 'dummy');
                }
            } catch (error) {
                console.error('Erro no carregamento, usando dados dummy:', error);
                showChart(dummyData, 'dummy');
            } finally {
                isLoadingData = false;
            }
        }

        // File input handler
        fileInput.addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                uploadButton.classList.add('active');
            } else {
                fileName.textContent = 'Nenhum arquivo selecionado';
                uploadButton.classList.remove('active');
            }
        });

        // Upload handler
        uploadButton.addEventListener('click', async function() {
            if (!selectedFile || isLoadingData) return;

            showStatus('Enviando imagem...', 'loading');

            const formData = new FormData();
            formData.append('image', selectedFile);

            try {
                const uploadResponse = await fetch('https://n8n-n8n-start.inrkp8.easypanel.host/webhook/data-extractor', {
                    method: 'POST',
                    mode: 'cors',
                    body: formData
                });

                if (uploadResponse.ok) {
                    showStatus('‚úÖ Imagem enviada! Atualizando dados...', 'loading');
                    
                    // Wait a bit for the API to process the image
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Reload data after successful upload
                    await loadAndShowData();
                    
                    showStatus('‚úÖ Imagem enviada e dados atualizados com sucesso!', 'success');
                    
                    // Reset form
                    fileInput.value = '';
                    selectedFile = null;
                    fileName.textContent = 'Nenhum arquivo selecionado';
                    uploadButton.classList.remove('active');
                } else {
                    throw new Error(`Erro ${uploadResponse.status}: ${uploadResponse.statusText}`);
                }
            } catch (error) {
                console.error('Erro no upload:', error);
                showStatus('‚ùå Erro ao enviar imagem. Tente novamente.', 'error');
            }
        });

        // Status message handler
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type} show`;
            
            if (type === 'loading') {
                statusMessage.innerHTML = '<div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>' + message;
            }

            // Auto hide success/error messages
            if (type !== 'loading') {
                setTimeout(() => {
                    statusMessage.classList.remove('show');
                }, 5000);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Inicializando aplica√ß√£o...');
            
            // Wait for Chart.js to be fully loaded
            if (typeof Chart === 'undefined') {
                console.log('Aguardando Chart.js carregar...');
                await new Promise(resolve => {
                    const checkChart = setInterval(() => {
                        if (typeof Chart !== 'undefined') {
                            clearInterval(checkChart);
                            resolve();
                        }
                    }, 100);
                });
            }
            
            // Add small delay to ensure DOM is ready
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Load and show data (will use dummy data if API is not available)
            await loadAndShowData();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            isLoadingData = false;
            destroyChart();
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible' && !pressureChart && !isLoadingData) {
                console.log('P√°gina voltou a ficar vis√≠vel, recarregando dados...');
                setTimeout(() => {
                    loadAndShowData();
                }, 1000);
            }
        });
    </script>
</body>
</html>
